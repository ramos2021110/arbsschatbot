
<!DOCTYPE html>

<html lang="en">
  <head>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-KyZXEAg3QhqLMpG8sDF4Gb5+76mJK5t4KpjgHXk6Vx7s3NFMWVk6YuG07Cx5tSyB" crossorigin="anonymous"> -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CEUMKT- Arbss the Chatbot</title> <!-- SELF EXPLANATORY  -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/MutationObserver.js/0.2.8/mutationobserver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/1.3.1/forge.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/2.3.1/jsencrypt.min.js"></script>
    
    
    <link rel="stylesheet" href="../static/arbsscss.css"/>
    <link rel="icon" type="image/x-icon" href="../static/images/arbssidle.gif" sizes="32x32">
  </head>

  <body>
    <div class="wholecontent" id = "wholecontent">            
                                           
      <!-- CHAT CONTAINER -->            
      <div class="chat-container" id="chat-container">            
              
        <!-- DARKMODE TITLE and GIF FONTSIZE-->            
        <div class="hometitle">            
    
          <!-- Dark Mode Label -->            
          <div>            
            <input type="checkbox" class="checkbox" id="checkbox">            
            <label for="checkbox" class="checkbox-label">            
              <span class="ball"></span>            
              <span class = "suncss">&#9728;</span> <!-- Sun icon -->            
              <span class = "mooncss">&#127765;</span> <!-- Moon icon -->            
            </label>            
          </div>            
                
          <!-- Title and GIF -->            
          <div class="arbss-container">            
            <img id="arbsschatbotpic" src="../static/images/arbssidle.gif" class="arbsimgcss">            
            <div class="arbss">Arbss the Chatbot</div>            
          </div>            
                
          <!-- Font Size Buttons -->            
          <div style="display: flex; justify-content: flex-end; align-items: center;">            
            <div id="fontEnlarge-button" class="fontsizecss"></div>            
            <div id="fontSizeid" class="user-message"></div>            
            <div id="fontSmaller-button" class="fontsizecss"></div>            

          </div>            
        </div>            

    <div class = "chat-panel">            

      <div class="chat-box" id="chat-box"></div>            
                  
        <audio id="user-sound-effect" src="../static/sounds/sfxusermsg.wav" preload="auto"></audio>            
        <audio id="bot-sound-effect" src="../static/sounds/sfxbotmsg.wav" preload="auto"></audio>            
                    
        <!--USER SECTION -->            
        <div class = "usersect">            

          <!--HOME BUTTON -->            
          <div id="home-button" class="home-button"></div>

              <!--USER TEXT FIELD -->
            <input
              class="inputcss"
              type="text"
              id="user-input"
              placeholder=""
              oninput="checkLength(this)"
              maxlength="250" 
            />

          </div>

            <div>
              <input hidden id="pbkeys" value="{{clientCrypto}}">
              <!-- <input hidden id="pvkeys" value="{{chatbotCrypto}}"> -->
            </div>
            
            <div class = "bottomsect" >                              
              <p id = "datebeta" class = betacss></p>            
              <a class="feedbackcss" href="https://forms.gle/QsSfrhURrB4fFpui9" target="_blank">Send us a feedback!</a>            
              <p id="word-count" class = "wordcntcss">Character Count: </p>            
            </div> 

        </div>            
      </div>

        <!-- BG PICS -->             
        <div id = "ceulogoid"  class="ceu-logo"> </div>            
        <div id = "ceulogoid"  class="scholarpic"></div>

    </div>

    <!-- <script src="arbssjs.js"></script>  JAVASCRIPT -->
    <script src="../static/arbssjs.js"></script>
    <script type="text/javascript">
      // import { homedisabler } from '../static/arbssjs.js';
      $(document).ready(function() {
          var socket = io.connect("http://localhost:5000");

          socket.on('message', function(data) {
              $('#user-input').append($('<p>').text(data))
          });

          let pbkeys = document.getElementById('pbkeys').value;
          // let pbkeysn = pbkeys.replace(" ", "\n")
          $('#user-input').keypress(function (event) {
            var key = event.which;
            if (key == 13) {
                    let userInput = $('#user-input').val()
                    if(userInput.length>185){
                      let string1 = userInput.slice(0, 150);
                      let string2 = userInput.slice(150, userInput.length-1);
                      console.log(pbkeys);
                      let rsa = forge.pki.rsa;
                      let publicKey = forge.pki.publicKeyFromPem(pbkeys);
                      let userMessage1 = string1;
                      let userMessage2 = string2;
                      console.log(userMessage1);
                      let encrypted1 = publicKey.encrypt(userMessage1, 'RSA-OAEP', {
                                        md: forge.md.sha256.create(),
                                        mgf1: forge.mgf1.create()
                                      })
                      console.log(encrypted1);
                      let encrypted2 = publicKey.encrypt(userMessage2, 'RSA-OAEP', {
                                        md: forge.md.sha256.create(),
                                        mgf1: forge.mgf1.create()
                                      })
                      console.log(encrypted2);
                      let pki = forge.pki;
                      let send1 = forge.util.encode64(encrypted1);
                      let send2 = forge.util.encode64(encrypted2);
                      socket.send({twoparts: true, userMessageP1: send1, userMessageP2: send2});
                    } else {
                      console.log(pbkeys);
                      let rsa = forge.pki.rsa;
                      let publicKey = forge.pki.publicKeyFromPem(pbkeys);
                      let userMessage = userInput;
                      console.log(userMessage);
                      let encrypted = publicKey.encrypt(userMessage, 'RSA-OAEP', {
                                        md: forge.md.sha256.create(),
                                        mgf1: forge.mgf1.create()
                                      })
                      console.log(encrypted);
                      let pki = forge.pki;
                      let send = forge.util.encode64(encrypted);
                      socket.send({twoparts: false, userMessage: send});
                    };
              $('#user-input').val('');
              console.log("Went here after enter");
            }
          });

          function btnFunction(item) {
            item.addEventListener('click', () => {
              if(item.textContent.length>185){
                let string1 = item.textContent.slice(0, 150);
                let string2 = item.textContent.slice(150, item.textContent.length-1);
                console.log(pbkeys);
                let rsa = forge.pki.rsa;
                let publicKey = forge.pki.publicKeyFromPem(pbkeys);
                let userMessage1 = string1;
                let userMessage2 = string2;
                console.log(userMessage1);
                let encrypted1 = publicKey.encrypt(userMessage1, 'RSA-OAEP', {
                                  md: forge.md.sha256.create(),
                                  mgf1: forge.mgf1.create()
                                })
                console.log(encrypted1);
                let encrypted2 = publicKey.encrypt(userMessage2, 'RSA-OAEP', {
                                  md: forge.md.sha256.create(),
                                  mgf1: forge.mgf1.create()
                                })
                console.log(encrypted2);
                let pki = forge.pki;
                let send1 = forge.util.encode64(encrypted1);
                let send2 = forge.util.encode64(encrypted2);
                socket.send({twoparts: true, userMessageP1: send1, userMessageP2: send2});
              } else {
                console.log(pbkeys);
                let rsa = forge.pki.rsa;
                let publicKey = forge.pki.publicKeyFromPem(pbkeys);
                let userMessage = item.textContent;
                console.log(userMessage);
                let encrypted = publicKey.encrypt(userMessage, 'RSA-OAEP', {
                                  md: forge.md.sha256.create(),
                                  mgf1: forge.mgf1.create()
                                })
                console.log(encrypted);
                let pki = forge.pki;
                let send = forge.util.encode64(encrypted);
                socket.send({twoparts: false, userMessage: send});
              };
              
              $('#user-input').val('');
              console.log("Went here after enter");
            });
          }
          let btn = document.querySelectorAll("#button-input");
          console.log(btn);

          btn.forEach(btnFunction);
          // btn.addEventListener("click", function() {
          //   if(btn.textContent.length>185){
          //     let string1 = btn.textContent.slice(0, 150);
          //     let string2 = btn.textContent.slice(150, item.textContent.length-1);
          //     console.log(pbkeys);
          //     let rsa = forge.pki.rsa;
          //     let publicKey = forge.pki.publicKeyFromPem(pbkeys);
          //     let userMessage1 = string1;
          //     let userMessage2 = string2;
          //     console.log(userMessage1);
          //     let encrypted1 = publicKey.encrypt(userMessage1, 'RSA-OAEP', {
          //                       md: forge.md.sha256.create(),
          //                       mgf1: forge.mgf1.create()
          //                     })
          //     console.log(encrypted1);
          //     let encrypted2 = publicKey.encrypt(userMessage2, 'RSA-OAEP', {
          //                       md: forge.md.sha256.create(),
          //                       mgf1: forge.mgf1.create()
          //                     })
          //     console.log(encrypted2);
          //     let pki = forge.pki;
          //     let send1 = forge.util.encode64(encrypted1);
          //     let send2 = forge.util.encode64(encrypted2);
          //     socket.send({twoparts: true, userMessageP1: send1, userMessageP2: send2});
          //   } else {
          //     console.log(pbkeys);
          //     let rsa = forge.pki.rsa;
          //     let publicKey = forge.pki.publicKeyFromPem(pbkeys);
          //     let userMessage = btn.textContent;
          //     console.log(userMessage);
          //     let encrypted = publicKey.encrypt(userMessage, 'RSA-OAEP', {
          //                       md: forge.md.sha256.create(),
          //                       mgf1: forge.mgf1.create()
          //                     })
          //     console.log(encrypted);
          //     let pki = forge.pki;
          //     let send = forge.util.encode64(encrypted);
          //     socket.send({twoparts: false, userMessage: send});
          //   };
            
          //   $('#user-input').val('');
          //   console.log("Went here after enter");
          // });
          // $('button-input').onclick()
          let a = this.getElementById("home-button");
          let mainmenu = document.getElementsByClassName("mainmenu");


          function homedisabler(){

              if (!mainmenu.disabled) {
                mainmenu.disabled = true;

              } else {
                mainmenu.disabled = false;

              }

              }

          // let fontSizeDefault = 20
          // let chatbotfont = document.getElementsByClassName("bot-message");
          // let chatuserfont = document.getElementsByClassName("user-message");
          // let buttonsfont = document.getElementsByTagName("button");
          // let fontSize = document.getElementById("fontSizeid");
          // fontSize.innerHTML = fontSizeDefault;

            const domObserver = new MutationObserver((_mutationlist, observer) => {
              const buttons = document.querySelectorAll('[id=button-input]');

              if(buttons) {
                buttons.forEach(btnFunction);               
              
                // observer.disconnect();
              }
            })

            domObserver.observe(document.body, { childList: true, subtree: true });


          socket.on('arby_answers', function(data) {
            console.log(data["message"])
            let chatBox = document.getElementById("chat-box");
            let botMessage = document.createElement("div");
            // botMessage.style.fontSize = fontSizeDefault + 'px';//ddfdsfdf
            botMessage.classList.add("bot-message");
            let botReply = data["message"];
            homedisabler();
            botMessage.innerHTML = "ARBSS: " + botReply;
            chatBox.appendChild(botMessage);
            chatBox.scrollTop = chatBox.scrollHeight;

            // chatbox disable
            let userInput = document.getElementById("user-input");
            userInput.disabled = true;

            setTimeout(function() {
              userInput.disabled = false;
            }, 1000);
          })
      });
    </script>


  </body>
</html>